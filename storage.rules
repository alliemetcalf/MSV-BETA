rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Rule 1: Allow authenticated users to LIST the contents of the bucket.
    // This is required for the file list functionality to work.
    // 'list' permission should be on the collection, not on individual documents.
    allow list: if request.auth != null;

    // Rule 2: Allow authenticated users to READ any file.
    // This allows viewing files after they have been listed.
    match /{allPaths=**} {
      allow read: if request.auth != null;
    }
    
    // Rule 3: Allow authenticated users to WRITE to the 'lock-type-instructions' path.
    // This is for the image uploads in the admin panel.
    match /lock-type-instructions/{lockTypeId}/{fileName} {
      allow write: if request.auth != null && 
                    request.resource.size < 5 * 1024 * 1024 &&
                    request.resource.contentType.matches('image/.*');
    }

    // Rule 4: Generic rule to allow authenticated users to write files to the root.
    // This is for the main "Uploads" page functionality.
    match /{fileName} {
      allow write: if request.auth != null;
    }
  }
}
